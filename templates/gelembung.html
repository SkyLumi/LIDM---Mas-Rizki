<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangkap Rasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        /* Kontainer untuk setiap "layar" */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .hidden { display: none; }
        #gameCanvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
        }
        #webcam {
            transform: scaleX(-1);
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Import MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <audio id="bgm" src="{{ url_for('static', filename='audio/gelembung.m4a') }}" loop></audio>


    <!-- ======================== -->
    <!--     LAYAR 1: MENU UTAMA (Versi Multi-Layer) -->
    <!-- ======================== -->
    <div id="menu-screen" class="screen bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/bg.png') }}');">
        <div class="relative w-full h-full flex items-center justify-center">
            
            <!-- Panel Menu Utama -->
            <!-- TAMBAHKAN 'relative' DI SINI untuk menjadi acuan posisi tombol -->
            <div class="relative w-full max-w-8xl flex flex-col items-center">
                <img src="{{ url_for('static', filename='gelembung_img/titlebox.png') }}" alt="Menu Utama" class="w-10/12 z-10">

                <!-- Kontainer Tombol-Tombol -->
                <!-- GANTI class positioningnya dengan 'absolute' -->
                <div class="absolute bottom-12 md:bottom-16 left-0 right-0 flex justify-center gap-4 w-full z-20">
                    <button id="play-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonplay.png') }}" alt="Play" class="pointer-events-none">
                    </button>
                    <button id="settings-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonpengaturan.png') }}" alt="Pengaturan" class="pointer-events-none">
                    </button>
                    <button id="quit-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonkeluar.png') }}" alt="Keluar" class="pointer-events-none">
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ======================== -->
    <!--   LAYAR 1.5: PILIH LEVEL  -->
    <!-- ======================== -->
    <div id="level-screen" class="fixed top-0 left-0 w-full h-full hidden bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/background.png') }}');">
        
        <!-- Wrapper 'relative' yang mengisi seluruh layar untuk menjadi acuan posisi absolut -->
        <div class="relative w-full h-full">
            
            <!-- Box Level, diposisikan absolut di atas-tengah. Jarak dari atas diubah jadi 15% -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 max-w-2xl">
                <img src="{{ url_for('static', filename='gelembung_img/levelbox.png') }}" alt="Pilih Level Box" class="w-full">
                
                <!-- Container Tombol Level, dibuat 'absolute' agar menimpa gambar box -->
                <div class="absolute inset-0 flex justify-center items-end gap-6 lg:pb-80">
                    <button id="level-1-btn" class="transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/level1btn.png') }}" alt="Level 1" class="w-24 md:w-32">
                    </button>
                    <button id="level-2-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 2 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                    <button id="level-3-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 3 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                </div>
            </div>
        </div>
    </div>

    

    <!-- ======================== -->
    <!--     LAYAR 2: GAMEPLAY      -->
    <!-- ======================== -->
    <div id="game-screen" class="screen hidden bg-black">
        <div id="loading-container" class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-gray-700 font-semibold">Menunggu akses kamera...</p>
        </div>
        <div id="game-wrapper" class="w-full h-full hidden">
            <button id="exit-game-btn" class="absolute top-4 left-4 z-10 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">
                &larr; Keluar
            </button>
            <video id="webcam" class="hidden" autoplay playsinline></video>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>


    <!-- ======================== -->
    <!--      LOGIKA JAVASCRIPT     -->
    <!-- ======================== -->
    <script>
        // --- MANAJEMEN LAYAR & NAVIGASI ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelScreen = document.getElementById('level-screen')
        const playBtn = document.getElementById('play-btn');
        const level1Btn = document.getElementById('level-1-btn')
        const settingsBtn = document.getElementById('settings-btn');
        const quitBtn = document.getElementById('quit-btn');
        const exitGameBtn = document.getElementById('exit-game-btn');

        playBtn.addEventListener('click', () => {
            menuScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
        });
        settingsBtn.addEventListener('click', () => { alert('Halaman Pengaturan belum dibuat!'); });
        quitBtn.addEventListener('click', () => { alert('Tombol Keluar ditekan!'); });
        exitGameBtn.addEventListener('click', () => {
            stopGame();
            gameScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
        });
        level1Btn.addEventListener('click', () => {
            levelScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            startGame();
            bgm.play(); 
        });

        // --- Variabel & Referensi Game ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('gameCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');
        const gameWrapper = document.getElementById('game-wrapper');
        const bgm = document.getElementById('bgm');


        let score, lives, gameOver, gameStarted, bubbles, lastBubbleSpawnTime, hands, camera;
        let gameWon = false;
        let gameWonAnimationY = -500; // Posisi awal animasi (di atas layar)
        let gameWonAnimationStartTime = 0;
        let gameStartTime = 0;
        let elapsedSeconds = 0;
        let countdownActive = false;
        let countdownStartTime = 0;
        let countdownNumber = 3;

        // --- ASET GAMBAR ---
        let bubbleImage = new Image();
        bubbleImage.src = "{{ url_for('static', filename='gelembung_img/gelembung.png') }}"; // Pastikan nama file dan folder benar

        let scorePanelImage = new Image();
        scorePanelImage.src = "{{ url_for('static', filename='gelembung_img/scorepanel.png') }}";

        let lifeConeImage = new Image();
        lifeConeImage.src = "{{ url_for('static', filename='gelembung_img/life.png') }}";

        let waterEffectImage = new Image();
        waterEffectImage.src = "{{ url_for('static', filename='gelembung_img/efek-air.png') }}";

        let waterBottomImage = new Image();
        waterBottomImage.src = "{{ url_for('static', filename='gelembung_img/air.png') }}";

        let scoreFillImage = new Image();
        scoreFillImage.src = "{{ url_for('static', filename='gelembung_img/scorefill.png') }}";

        let gameOverImage = new Image();
        gameOverImage.src = "{{ url_for('static', filename='gelembung_img/gameover.png') }}";

        let timerImage = new Image();
        timerImage.src = "{{ url_for('static', filename='gelembung_img/timer.png') }}";

        let countdownThreeImage = new Image();
        countdownThreeImage.src = "{{ url_for('static', filename='gelembung_img/Three.png') }}";

        let countdownTwoImage = new Image();
        countdownTwoImage.src = "{{ url_for('static', filename='gelembung_img/Two.png') }}";

        let countdownOneImage = new Image();
        countdownOneImage.src = "{{ url_for('static', filename='gelembung_img/One.png') }}";


        // --- FUNGSI-FUNGSI GAMBAR ---
        function drawBubble(ctx, bubble) {
            if (!bubble) return;
            const bubbleSize = 100; // Sesuaikan ukuran gelembung
            ctx.drawImage(
                bubbleImage,
                bubble.x - bubbleSize / 2,
                bubble.y - bubbleSize / 2,
                bubbleSize,
                bubbleSize
            );
        }
        
        // --- FUNGSI-FUNGSI GAME ---
        function onResults(results) {
            if (!gameStarted && videoElement.videoWidth > 0) {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
                gameStarted = true;
                loadingContainer.classList.add('hidden');
                gameWrapper.classList.remove('hidden');
                // Mulai countdown
                countdownActive = true;
                countdownStartTime = Date.now();
                countdownNumber = 3;
            }
            if (!gameStarted) return;

            const w = canvasElement.width;
            const h = canvasElement.height;

            // --- UPDATE COUNTDOWN ---
            if (countdownActive) {
                const countdownElapsed = Date.now() - countdownStartTime;
                const currentCountdown = 3 - Math.floor(countdownElapsed / 1000);
                
                if (currentCountdown > 0) {
                    countdownNumber = currentCountdown;
                } else if (currentCountdown === 0) {
                    countdownNumber = 0;
                    // Countdown selesai, mulai game
                    if (countdownElapsed >= 3000) {
                        countdownActive = false;
                        gameStartTime = Date.now();
                    }
                }
            }

            // --- UPDATE LOGIKA GAME ---
            if (!gameOver && !countdownActive) {
                // 1. Munculkan Gelembung Baru (jika tidak ada gelembung di layar)
                if (bubbles.length === 0) {
                    let startX, startY, speedX, speedY;
                    const side = Math.floor(Math.random() * 4); // Pilih sisi acak (0=bawah, 1=atas, 2=kiri, 3=kanan)
                    const speed = Math.random() * 3 + 3; // Kecepatan dasar

                    switch (side) {
                        case 0: // Muncul dari BAWAH
                            startX = Math.random() * w;
                            startY = h + 50;
                            speedX = 0;
                            speedY = -speed; // Bergerak ke atas
                            break;
                        case 1: // Muncul dari ATAS
                            startX = Math.random() * w;
                            startY = -50;
                            speedX = 0;
                            speedY = speed; // Bergerak ke bawah
                            break;
                        case 2: // Muncul dari KIRI
                            startX = -50;
                            startY = Math.random() * h;
                            speedX = speed; // Bergerak ke kanan
                            speedY = 0;
                            break;
                        case 3: // Muncul dari KANAN
                            startX = w + 50;
                            startY = Math.random() * h;
                            speedX = -speed; // Bergerak ke kiri
                            speedY = 0;
                            break;
                    }

                    bubbles.push({
                        x: startX,
                        y: startY,
                        speedX: speedX,
                        speedY: speedY,
                        spawnTime: Date.now()
                    });
                }

                // 2. Gerakkan Gelembung & Deteksi Kondisi Pecah
                const bubblesToKeep = [];
                for (const bubble of bubbles) {
                    bubble.x += bubble.speedX;
                    bubble.y += bubble.speedY;

                    let bubblePopped = false;
                    const bubbleRadius = 50;
                    const waterEffectRadius = 60; // Diperbesar untuk deteksi lebih mudah

                    if (results.multiHandLandmarks && results.multiHandedness) {
                        for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                            const landmarks = results.multiHandLandmarks[i];

                            // Hitung pusat telapak tangan (sama seperti untuk gambar air)
                            const indexFingerBase = landmarks[5];
                            const middleFingerBase = landmarks[9];
                            const ringFingerBase = landmarks[13];
                            const pinkyFingerBase = landmarks[17];

                            const palmCenterX_normalized = (indexFingerBase.x + middleFingerBase.x + ringFingerBase.x + pinkyFingerBase.x) / 4;
                            const palmCenterY_normalized = (indexFingerBase.y + middleFingerBase.y + ringFingerBase.y + pinkyFingerBase.y) / 4;

                            // Koordinat tangan - dalam sistem koordinat yang sudah di-mirror (untuk visual)
                            const palmCenterX_visual = palmCenterX_normalized * w;
                            const palmCenterY_visual = palmCenterY_normalized * h;
                            
                            // Untuk collision, gunakan koordinat visual yang sama (TIDAK perlu konversi)
                            // Karena gelembung juga menggunakan koordinat dalam sistem yang sama
                            const palmCenterX_hitbox = palmCenterX_visual;
                            const palmCenterY_hitbox = palmCenterY_visual;

                            // Koordinat gelembung - dalam sistem koordinat yang sama dengan tangan
                            const bubbleX_hitbox = bubble.x;
                            const bubbleY_hitbox = bubble.y;
                            
                            // Hitung jarak
                            const dist = Math.sqrt(Math.pow(palmCenterX_hitbox - bubbleX_hitbox, 2) + Math.pow(palmCenterY_hitbox - bubbleY_hitbox, 2));

                            // Debug: AKTIF untuk melihat nilai
                            console.log(`Hand: (${palmCenterX_hitbox.toFixed(0)}, ${palmCenterY_hitbox.toFixed(0)}), Bubble: (${bubbleX_hitbox.toFixed(0)}, ${bubbleY_hitbox.toFixed(0)}), Dist: ${dist.toFixed(0)}, Threshold: ${(bubbleRadius + waterEffectRadius)}`);

                            if (dist < bubbleRadius + waterEffectRadius) {
                                console.log('BUBBLE POPPED!');
                                bubblePopped = true;
                                break;
                            }
                        }
                    }

                    if (bubblePopped) {
                        score += 10;
                        // Cek jika skor mencapai 100 atau lebih
                        if (score >= 100 && !gameWon) {
                            gameWon = true;
                            gameWonAnimationStartTime = Date.now();
                        }
                    } else if (bubble.y < -50 || bubble.y > h + 50 || bubble.x < -50 || bubble.x > w + 50) { // Cek jika keluar dari semua sisi
                        lives -= 1;
                    } else {
                        bubblesToKeep.push(bubble);
                    }
                }
                bubbles = bubblesToKeep;

                if (lives <= 0) {
                    gameOver = true;
                    lives = 0;
                }
            }
            
            // --- GAMBAR SEMUA ELEMEN ---
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, w, h);
            
            // 1. Gambar Video FULL SCREEN dengan cover behavior dan mirror effect
            const videoRatio = videoElement.videoWidth / videoElement.videoHeight;
            const canvasRatio = w / h;
            let drawWidth, drawHeight;
            let offsetX = 0, offsetY = 0;
            
            // Hitung ukuran untuk mengisi penuh layar (cover behavior)
            if (videoRatio > canvasRatio) {
                // Video lebih lebar, fit ke tinggi dan crop samping
                drawHeight = h;
                drawWidth = h * videoRatio;
                offsetX = (drawWidth - w) / 2;
            } else {
                // Video lebih tinggi, fit ke lebar dan crop atas/bawah
                drawWidth = w;
                drawHeight = w / videoRatio;
                offsetY = (drawHeight - h) / 2;
            }
            
            // Flip horizontal untuk mirror effect pada video
            canvasCtx.save();
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-w, 0);
            canvasCtx.drawImage(results.image, -offsetX, -offsetY, drawWidth, drawHeight);
            canvasCtx.restore();

            // 2. Gambar Gelembung dengan mirror
            canvasCtx.save();
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-w, 0);
            for (const bubble of bubbles) {
                drawBubble(canvasCtx, bubble);
            }
            canvasCtx.restore();
            
            // 3. Gambar Kerangka & Efek Air Tangan dengan mirror
            if (results.multiHandLandmarks && results.multiHandedness) {
                canvasCtx.save();
                canvasCtx.scale(-1, 1);
                canvasCtx.translate(-w, 0);
                
                for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                    const landmarks = results.multiHandLandmarks[i];

                    // Gambar Kerangka (Debugging) - Uncomment jika perlu debug
                    // window.drawConnectors(canvasCtx, landmarks, window.HAND_CONNECTIONS, { color: '#FFFFFF', lineWidth: 5 });
                    // window.drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 2 });

                    // Gambar Efek Air di tengah telapak tangan
                    const wrist = landmarks[0];
                    const indexFingerBase = landmarks[5];
                    const middleFingerBase = landmarks[9];
                    const ringFingerBase = landmarks[13];
                    const pinkyFingerBase = landmarks[17];

                    // Hitung pusat telapak tangan dengan lebih akurat
                    const palmCenterX_normalized = (indexFingerBase.x + middleFingerBase.x + ringFingerBase.x + pinkyFingerBase.x) / 4;
                    const palmCenterY_normalized = (indexFingerBase.y + middleFingerBase.y + ringFingerBase.y + pinkyFingerBase.y) / 4;

                    // Karena sudah di-mirror, koordinat X langsung digunakan
                    const palmCenterX = palmCenterX_normalized * w;
                    const palmCenterY = palmCenterY_normalized * h;
                    
                    const waterEffectSize = 120;
                    canvasCtx.drawImage(waterEffectImage, palmCenterX - waterEffectSize / 2, palmCenterY - waterEffectSize / 2, waterEffectSize, waterEffectSize);
                }
                
                canvasCtx.restore();
            }

            canvasCtx.restore();

            // 4. Gambar Air di Bawah Layar
            const waterBottomHeight = 150; // Tinggi gambar air
            const waterBottomWidth = w; // Lebar penuh layar
            canvasCtx.drawImage(waterBottomImage, 0, h - waterBottomHeight, waterBottomWidth, waterBottomHeight);

            // --- GAMBAR SEMUA UI STATIS (TIDAK BERUBAH) ---
            const panelWidth = 120;
            const panelHeight = 420;
            const panelX = w - panelWidth - 140;
            const panelY = h / 2 - panelHeight / 2;
            
            // Gambar Score Fill (progress bar) di belakang panel
            const maxScore = 100;
            const scorePercentage = Math.min(score / maxScore, 1);
            
            // Batasi tinggi maksimal fill (85% dari tinggi panel agar tidak melebihi)
            const maxFillHeight = panelHeight * 0.85; // 85% dari tinggi panel
            const fillHeight = maxFillHeight * scorePercentage;
            
            // Atur lebar scorefill (bisa disesuaikan)
            const fillWidth = panelWidth * 0.65; // 65% dari lebar panel
            const fillOffsetX = ((panelWidth - fillWidth) / 2) + 10; // Center horizontally
            
            // Offset dari bawah panel
            const fillBottomOffset = -2; // Jarak dari bawah panel (diperbesar agar lebih ke bawah)
            
            if (scorePercentage > 0) {
                canvasCtx.drawImage(
                    scoreFillImage,
                    0, scoreFillImage.height * (1 - scorePercentage),
                    scoreFillImage.width, scoreFillImage.height * scorePercentage,
                    panelX + fillOffsetX, panelY + (panelHeight - fillHeight - fillBottomOffset),
                    fillWidth, fillHeight
                );
            }
            
            canvasCtx.drawImage(scorePanelImage, panelX, panelY, panelWidth, panelHeight);

            const formattedScore = String(score).padStart(2, '0');
            canvasCtx.fillStyle = '#FFFFFF';
            canvasCtx.font = 'bold 48px sans-serif'; 
            canvasCtx.textAlign = 'center'; 
            canvasCtx.fillText(formattedScore, panelX + (panelWidth / 2) + 30, panelY - 20);
            canvasCtx.textAlign = 'left'; 

            const lifeIconWidth = 100;
            const lifeIconHeight = 90;
            const padding = 20;
            const startX = 60; 
            const startY = 50;
            const spacing = 5;
            for (let i = 0; i < lives; i++) {
                canvasCtx.drawImage(lifeConeImage, startX + (i * (lifeIconWidth + spacing)), startY, lifeIconWidth, lifeIconHeight);
            }

            // Gambar Timer di pojok kanan atas
            if (!gameOver && !gameWon) {
                elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
            }
            
            const timerWidth = 360;
            const timerHeight = 180;
            const timerX = w - timerWidth - 100;
            const timerY = 20;
            
            canvasCtx.drawImage(timerImage, timerX, timerY, timerWidth, timerHeight);
            
            // Gambar text waktu di dalam timer box
            canvasCtx.fillStyle = '#2C5F6F'; // Warna teal gelap sesuai gambar
            canvasCtx.font = 'bold 36px sans-serif';
            canvasCtx.textAlign = 'center';
            canvasCtx.fillText(`Waktu : ${elapsedSeconds} detik`, timerX + (timerWidth / 2), timerY + (timerHeight / 2) + 50);
            canvasCtx.textAlign = 'left';

            if (countdownActive && countdownNumber > 0) {
                let countdownImage;
                if (countdownNumber === 3) {
                    countdownImage = countdownThreeImage;
                } else if (countdownNumber === 2) {
                    countdownImage = countdownTwoImage;
                } else if (countdownNumber === 1) {
                    countdownImage = countdownOneImage;
                }

                if (countdownImage && countdownImage.complete) {
                    const imgWidth = 200; // Lebar gambar countdown
                    const imgHeight = 240; // Tinggi gambar countdown
                    const imgX = (w - imgWidth) / 2; // Posisi X di tengah
                    const imgY = (h - imgHeight) / 2; // Posisi Y di tengah
                    
                    // Beri sedikit efek bayangan
                    canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    canvasCtx.fillRect(0, 0, w, h);

                    // Gambar angka countdown
                    canvasCtx.drawImage(countdownImage, imgX, imgY, imgWidth, imgHeight);
                }
            }

            // Gambar Game Won overlay dengan animasi
            if (gameWon) {
                const animationDuration = 1000; // 1 detik untuk animasi turun
                const elapsedTime = Date.now() - gameWonAnimationStartTime;
                const progress = Math.min(elapsedTime / animationDuration, 1); // 0 to 1
                
                // Easing function (ease-out)
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                // Hitung posisi Y (dari -500 ke 0)
                gameWonAnimationY = -500 + (500 * easeOut);
                
                // Gambar overlay gelap
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                canvasCtx.fillRect(0, 0, w, h);
                
                // Gambar gameover image dengan animasi dari atas
                const gameOverWidth = w * 0.3; // 60% dari lebar layar
                const gameOverHeight = gameOverWidth * (gameOverImage.height / gameOverImage.width); // Maintain aspect ratio
                const gameOverX = (w - gameOverWidth) / 2;
                const gameOverY = (h - gameOverHeight) / 2 + gameWonAnimationY;
                
                canvasCtx.drawImage(gameOverImage, gameOverX, gameOverY, gameOverWidth, gameOverHeight);
            }

            if (gameOver) {
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                canvasCtx.fillRect(0, h / 2 - 60, w, 120);
                canvasCtx.fillStyle = 'white';
                canvasCtx.textAlign = 'center';
                canvasCtx.font = 'bold 50px sans-serif';
                canvasCtx.fillText('GAME OVER', w / 2, h / 2);
                canvasCtx.font = '30px sans-serif';
                canvasCtx.fillText(`Skor Akhir: ${score}`, w / 2, h / 2 + 40);
                canvasCtx.textAlign = 'left';
            }
        
        }

        function startGame() {
            score = 0; lives = 3; gameOver = false; gameStarted = false;
            gameWon = false;
            gameWonAnimationY = -500;
            gameWonAnimationStartTime = 0;
            gameStartTime = 0;
            elapsedSeconds = 0;
            countdownActive = false;
            countdownStartTime = 0;
            countdownNumber = 3;
            bubbles = [];
            
            loadingContainer.classList.remove('hidden');
            gameWrapper.classList.add('hidden');

            if (!hands) {
                hands = new window.Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
                });
                hands.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5, staticImageMode: false, selfieMode: false });
                hands.onResults(onResults);
            }
            if (!camera) {
                camera = new window.Camera(videoElement, {
                    onFrame: async () => await hands.send({ image: videoElement }),
                    width: 640, height: 480,
                });
            }
            
            camera.start().catch(err => {
                loadingText.innerText = 'Gagal mengakses kamera. Pastikan diizinkan.';
            });
        }

        function stopGame() {
            if (camera) {
                camera.stop();
                bgm.pause();
                bgm.currentTime = 0; 
            }
        }
    </script>
</body>
</html>

