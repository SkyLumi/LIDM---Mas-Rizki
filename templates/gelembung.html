<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangkap Rasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Raleway:wght@600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        /* Kontainer untuk setiap "layar" */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .hidden { display: none; }
        #gameCanvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
        }

        #result-popup {
            opacity: 0;
            transform: translateY(-80px);
            transition: all 0.7s cubic-bezier(0.22, 1, 0.36, 1);
        }

        #result-popup.active {
            opacity: 1;
            transform: translateY(0);
        }

        #result-text {
            text-shadow: 2px 2px 0 rgba(255, 255, 255, 0.3);
        }

        #settings-overlay {
            transition: opacity 0.3s ease;
        }
        #settings-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #webcam {
            transform: scaleX(-1);
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Import MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <audio id="bgm" src="{{ url_for('static', filename='audio/gelembung.m4a') }}" loop></audio>

    <!-- ======================== -->
    <!--     LAYAR 1: MENU UTAMA (Versi Multi-Layer) -->
    <!-- ======================== -->
    <div id="menu-screen" class="screen bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/bg.png') }}');">
        <div class="relative w-full h-full flex items-center justify-center">
            
            <!-- Panel Menu Utama -->
            <!-- TAMBAHKAN 'relative' DI SINI untuk menjadi acuan posisi tombol -->
            <div class="relative w-full max-w-8xl flex flex-col items-center">
                <img src="{{ url_for('static', filename='gelembung_img/titlebox.png') }}" alt="Menu Utama" class="w-10/12 z-10">

                <!-- Kontainer Tombol-Tombol -->
                <!-- GANTI class positioningnya dengan 'absolute' -->
                <div class="absolute bottom-12 md:bottom-16 left-0 right-0 flex justify-center gap-4 w-full z-20">
                    <button id="play-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonplay.png') }}" alt="Play" class="pointer-events-none">
                    </button>
                    <button id="settings-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonpengaturan.png') }}" alt="Pengaturan" class="pointer-events-none">
                    </button>
                    <button id="quit-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonkeluar.png') }}" alt="Keluar" class="pointer-events-none">
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ======================== -->
    <!--   LAYAR 1.5: PILIH LEVEL  -->
    <!-- ======================== -->
    <div id="level-screen" class="fixed top-0 left-0 w-full h-full hidden bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/background.png') }}');">
        
        <!-- Wrapper 'relative' yang mengisi seluruh layar untuk menjadi acuan posisi absolut -->
        <div class="relative w-full h-full">
            <!-- Box Level, diposisikan absolut di atas-tengah. Jarak dari atas diubah jadi 15% -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 max-w-2xl">
                <img src="{{ url_for('static', filename='gelembung_img/levelbox.png') }}" alt="Pilih Level Box" class="w-full">
                <button id="levelmenuback-btn"
                    class="absolute -top-[6%] -right-[5%] z-50 hover:scale-110 transition-transform duration-200">
                    <img src="{{ url_for('static', filename='gelembung_img/close-button.png') }}"
                        alt="Kembali" class="w-[100px]" />
                </button>
                <!-- Container Tombol Level, dibuat 'absolute' agar menimpa gambar box -->
                <div class="absolute inset-0 flex justify-center items-end gap-6 lg:pb-80">
                    <button id="level-1-btn" class="transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/level1btn-selected.png') }}" alt="Level 1" class="w-24 md:w-32">
                    </button>
                    <button id="level-2-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 2 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                    <button id="level-3-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 3 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorial-screen" class="screen hidden" style="background-color: rgba(0, 0, 0, 0.7);  z-index: 20;">
        <div class="flex flex-col items-center gap-8 ">
            <img src="{{ url_for('static', filename='gelembung_img/tutorial.png') }}" alt="Tutorial Cara Bermain" class="w-full">
            
            <button id="understand-btn" class="w-1/4 max-w-xs transform hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/mulaiButton.png') }}" alt="Lanjutkan">
            </button>
        </div>
    </div>
    

    <!-- ======================== -->
    <!--     LAYAR 2: GAMEPLAY      -->
    <!-- ======================== -->
    <div id="game-screen" class="screen hidden bg-black" style="z-index: 10;">
        <div id="loading-container" class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-gray-700 font-semibold">Menunggu akses kamera...</p>
        </div>
        <div id="game-wrapper" class="w-full h-full hidden">
            <video id="webcam" style="position: absolute; visibility: hidden;" autoplay playsinline></video>
            <canvas id="gameCanvas"></canvas>
            <button id="pause-btn"
                class="absolute bottom-20 left-20 z-50 hover:scale-110 transition-transform duration-200 hidden">
                <img src="{{ url_for('static', filename='gelembung_img/pause-button.png') }}"
                    alt="Pause" class="w-[150px]" />
            </button>

        </div>
    </div>

    <!-- ======================== -->
    <!--     RESULT SCREEN        -->
    <!-- ======================== -->
    <div id="result-screen" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-50">
    <div id="result-popup" class="relative flex flex-col items-center transition-all duration-700 ease-out transform -translate-y-full">
        <!-- Gambar hasil -->
        <img id="result-image" src="" alt="result background" class="w-[720px] h-auto mx-auto" />

        <!-- Tulisan skor -->
        <div id="result-text"
        class="absolute inset-0 flex flex-col items-center justify-center font-['Lilita_One'] text-[#00446b] space-y-2 transform -translate-y-[5%]">
        
        <!-- Tulisan utama -->
        <div id="result-status"
            class="text-[96px] leading-tight text-[#045170] text-center break-words max-w-[6ch] mx-auto">
            KERJA BAGUS!
        </div>
        
        <!-- Skor -->
        <div class="text-[48px] text-[#045170] font-['Raleway'] font-extrabold">
            Score: <span id="result-score" class="text-[#FE6291] text-[48px] font-['Raleway'] font-bold">0</span>
        </div>
        </div>

        <!-- Tombol Home, Retry, dan Next Level -->
        <div class="absolute bottom-[8%] left-1/2 transform -translate-x-1/2 flex gap-14">
        <button id="home-btn">
            <img src="{{ url_for('static', filename='gelembung_img/home-button.png') }}" 
                alt="Home"
                class="w-[150px] h-auto min-w-[150px] hover:scale-110 transition-transform duration-200 object-contain" />
        </button>

        <button id="retry-btn">
            <img src="{{ url_for('static', filename='gelembung_img/retry-button.png') }}" 
                alt="Retry"
                class="w-[150px] h-auto min-w-[150px] hover:scale-110 transition-transform duration-200 object-contain" />
        </button>

        <button id="nextLevelBtn-btn" class="hidden">
            <img src="{{ url_for('static', filename='gelembung_img/nextlevel-button.png') }}" 
                alt="Next Level"
                class="w-[150px] h-auto min-w-[150px] hover:scale-110 transition-transform duration-200 object-contain" />
        </button>
    </div>

    </div>
    </div>

    <!-- ======================== -->
    <!--     SETTINGS SCREEN      -->
    <!-- ======================== -->
    <!-- Overlay -->
    <div id="settings-overlay"
        class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-md z-50">

        <!-- Popup -->
        <div id="settings-popup" class="relative">
            <img src="{{ url_for('static', filename='gelembung_img/setting-menu.png') }}"
                alt="Setting Menu"
                class="w-[730px] h-auto pointer-events-none select-none" />

            <!-- Tombol Close -->
            <button id="settings-close"
                class="absolute -top-[5%] -right-[5%] z-10 hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/close-button.png') }}"
                    alt="Close" class="w-[100px]" />
            </button>

            <!-- Konten -->
            <div
                class="absolute inset-0 flex flex-col justify-center items-end pr-24 text-[#00446b] font-['Lilita_One'] text-[36px] space-y-12 z-0 transform translate-y-[10%]">

                <!-- Efek -->
                <div class="flex gap-10 items-center">
                    <img id="effect-sound"
                        src="{{ url_for('static', filename='gelembung_img/sound-active-button.png') }}"
                        alt="Efek On"
                        class="w-[120px] cursor-pointer transition-transform hover:scale-110">
                    <img id="effect-mute"
                        src="{{ url_for('static', filename='gelembung_img/mute-nonactive-button.png') }}"
                        alt="Efek Off"
                        class="w-[120px] cursor-pointer transition-transform hover:scale-110">
                </div>

                <!-- Musik -->
                <div class="flex gap-10 items-center">
                    <img id="music-sound"
                        src="{{ url_for('static', filename='gelembung_img/sound-active-button.png') }}"
                        alt="Musik On"
                        class="w-[120px] cursor-pointer transition-transform hover:scale-110">
                    <img id="music-mute"
                        src="{{ url_for('static', filename='gelembung_img/mute-nonactive-button.png') }}"
                        alt="Musik Off"
                        class="w-[120px] cursor-pointer transition-transform hover:scale-110">
                </div>
            </div>
        </div>
    </div>

    <!-- ======================== -->
    <!--        PAUSE MENU        -->
    <!-- ======================== -->
    <!-- PAUSE MENU OVERLAY -->
    <div id="pause-overlay" 
        class="hidden fixed inset-0 bg-black bg-opacity-40 backdrop-blur-md flex items-center justify-center z-[60]">
        <div class="relative">
            <img src="{{ url_for('static', filename='gelembung_img/pause-menu.png') }}" 
                alt="Paused" 
                class="w-[800px] select-none pointer-events-none" />
            
            <!-- Tombol Continue -->
            <button id="pause-continue" 
                    class="absolute bottom-[18%] left-[30%] transform -translate-x-1/2 hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/continue-button.png') }}" 
                    alt="Continue" class="w-[120px]" />
            </button>

            <!-- Tombol Home -->
            <button id="pause-home" 
                    class="absolute bottom-[18%] left-1/2 transform -translate-x-1/2 hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/home-button.png') }}" 
                    alt="Home" class="w-[120px]" />
            </button>

            <!-- Tombol Retry -->
            <button id="pause-retry" 
                    class="absolute bottom-[18%] left-[70%] transform -translate-x-1/2 hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/retry-button.png') }}" 
                    alt="Retry" class="w-[120px]" />
            </button>
        </div>
    </div>



    <!-- ======================== -->
    <!--      LOGIKA JAVASCRIPT     -->
    <!-- ======================== -->
    <script>
        // ==========================================
        // REFERENSI ELEMEN DOM
        // ==========================================
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelScreen = document.getElementById('level-screen');
        const tutorialScreen = document.getElementById('tutorial-screen');
        const resultScreen = document.getElementById('result-screen');

        const playBtn = document.getElementById('play-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const quitBtn = document.getElementById('quit-btn');
        const understandBtn = document.getElementById('understand-btn');
        const homeBtn = document.getElementById('home-btn');
        const retryBtn = document.getElementById('retry-btn');
        const nextLevelBtn = document.getElementById("nextLevelBtn-btn");

        const levelmenuClose = document.getElementById('levelmenuback-btn');
        const settingsOverlay = document.getElementById('settings-overlay');
        const closeSettings = document.getElementById('settings-close');
        const effectSound = document.getElementById('effect-sound');
        const effectMute = document.getElementById('effect-mute');
        const musicSound = document.getElementById('music-sound');
        const musicMute = document.getElementById('music-mute');

        const level1Btn = document.getElementById('level-1-btn');
        const level2Btn = document.getElementById('level-2-btn');
        const level3Btn = document.getElementById('level-3-btn');

        const bgm = document.getElementById('bgm');
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('gameCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');
        const gameWrapper = document.getElementById('game-wrapper');

        const pauseBtn = document.getElementById('pause-btn');
        const pauseOverlay = document.getElementById('pause-overlay');
        const pauseContinue = document.getElementById('pause-continue');
        const pauseHome = document.getElementById('pause-home');
        const pauseRetry = document.getElementById('pause-retry');

        // ==========================================
        // VARIABEL GLOBAL GAME STATE
        // ==========================================
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let gameOver = false;
        let gameWon = false;
        let gameStarted = false;
        let bubbles = [];
        let hands = null;
        let camera = null;
        let effectOn = true;
        let musicOn = true;

        let isTutorialActive = true;
        let countdownActive = false;
        let countdownStartTime = 0;
        let countdownNumber = 3;
        let gameStartTime = 0;
        let elapsedSeconds = 0;
        let gamePaused = false;
        let lastResults = null;
        let lastFrameTime = 0;
        let pauseStartTime = 0;
        let totalPausedDuration = 0;


        // PROGRESS SISTEM - Menyimpan progres pemain (dalam memori)
        let playerProgress = {
            1: { unlocked: true, stars: 0, bestScore: 0, bestTime: 999 },
            2: { unlocked: false, stars: 0, bestScore: 0, bestTime: 999 },
            3: { unlocked: false, stars: 0, bestScore: 0, bestTime: 999 }
        };

        // Testing
         //playerProgress[2].unlocked = true;
         //playerProgress[3].unlocked = true;

        // ==========================================
        // KONFIGURASI LEVEL
        // ==========================================
        const levelConfig = {
            1: {
                allowedTypes: ["blue", "purple"],
                maxBubbles: 1,
                speedMultiplier: 1.0,
                targetScore: 100
            },
            2: {
                allowedTypes: ["blue", "purple", "bomb"],
                maxBubbles: 2,
                speedMultiplier: 1.0,
                targetScore: 100
            },
            3: {
                allowedTypes: ["blue", "purple", "bomb"],
                maxBubbles: 3,
                speedMultiplier: 1.3,
                targetScore: 100
            }
        };

        // ==========================================
        // ASET GAMBAR
        // ==========================================
        const images = {};
        const imageUrls = {
            bubble: "{{ url_for('static', filename='gelembung_img/gelembung.png') }}",
            scorePanel: "{{ url_for('static', filename='gelembung_img/scorepanel.png') }}",
            lifeCone: "{{ url_for('static', filename='gelembung_img/life.png') }}",
            waterEffect: "{{ url_for('static', filename='gelembung_img/efek-air.png') }}",
            waterBottom: "{{ url_for('static', filename='gelembung_img/air.png') }}",
            scoreFill: "{{ url_for('static', filename='gelembung_img/scorefill.png') }}",
            gameOver: "{{ url_for('static', filename='gelembung_img/gameover.png') }}",
            timer: "{{ url_for('static', filename='gelembung_img/timer.png') }}",
            countdownThree: "{{ url_for('static', filename='gelembung_img/Three.png') }}",
            countdownTwo: "{{ url_for('static', filename='gelembung_img/Two.png') }}",
            countdownOne: "{{ url_for('static', filename='gelembung_img/One.png') }}",
            waterEffectAnimation: "{{ url_for('static', filename='gelembung_img/efek-air-animasi.png') }}",
            blueBubbleAnimation: "{{ url_for('static', filename='gelembung_img/blue-bubble-animation.png') }}",
            purpleBubbleAnimation: "{{ url_for('static', filename='gelembung_img/purple-bubble-animation.png') }}",
            bomBubbleAnimation: "{{ url_for('static', filename='gelembung_img/bom-bubble-animation.png') }}",
            resultStar0: "{{ url_for('static', filename='gelembung_img/result-0-star.png') }}",
            resultStar1: "{{ url_for('static', filename='gelembung_img/result-1-star.png') }}",
            resultStar2: "{{ url_for('static', filename='gelembung_img/result-2-star.png') }}",
            resultStar3: "{{ url_for('static', filename='gelembung_img/result-3-star.png') }}",
            homeButton: "{{ url_for('static', filename='gelembung_img/home-button.png') }}",
            retryButton: "{{ url_for('static', filename='gelembung_img/retry-button.png') }}",
            pauseButton: "{{ url_for('static', filename='gelembung_img/pause-button.png') }}",
            continueButton: "{{ url_for('static', filename='gelembung_img/continue-button.png') }}",
        };

        Object.keys(imageUrls).forEach(key => {
            images[key] = new Image();
            images[key].src = imageUrls[key];
        });

        // ==========================================
        // KONFIGURASI ANIMASI
        // ==========================================
        const waterAnim = {
            frameWidth: 424,
            frameHeight: 424,
            frameCount: 7,
            frameIndex: 0,
            frameSpeed: 80,
            lastFrameTime: 0,
        };

        const bubbleAnim = {
            frameWidth: 520,
            frameHeight: 520,
            frameCount: 6,
            frameSpeed: 50,
        };

        function calculateStars(score, time) {
            if (score < levelConfig[currentLevel].targetScore) return 0;
            if (time <= 30) return 3;
            if (time <= 60) return 2;
            return 1;
        }

        function unlockNextLevel(completedLevel) {
            if (completedLevel < 3) {
                playerProgress[completedLevel + 1].unlocked = true;
                updateLevelButtons();
            }
        }

        function updateLevelButtons() {
            const basePath = "{{ url_for('static', filename='gelembung_img') }}";

            const levelButtons = [
                { btn: level1Btn, level: 1, selected: 'level1btn-selected.png', unselected: 'level1btn-unselected.png' },
                { btn: level2Btn, level: 2, selected: 'level2btn-selected.png', unselected: 'level2btn-unselected.png' },
                { btn: level3Btn, level: 3, selected: 'level3btn-selected.png', unselected: 'level3btn-unselected.png' }
            ];

            levelButtons.forEach(({ btn, level, selected, unselected }) => {
                const progress = playerProgress[level];
                const img = btn.querySelector('img');

                if (progress.unlocked) {
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed');
                    btn.classList.add('hover:scale-110', 'transition-transform', 'duration-200');
                    img.classList.remove('opacity-50');
                    img.src = `${basePath}/${unselected}`;

                    // Ganti gambar saat hover
                    btn.addEventListener('mouseenter', () => {
                        img.src = `${basePath}/${selected}`;
                    });
                    btn.addEventListener('mouseleave', () => {
                        img.src = `${basePath}/${unselected}`;
                    });
                } else {
                    btn.disabled = true;
                    btn.classList.add('cursor-not-allowed');
                    btn.classList.remove('hover:scale-110', 'transition-transform', 'duration-200');
                    img.classList.add('opacity-50');
                    img.src = `${basePath}/levellock.png`;
                }
            });
        }

        // ==========================================
        // EVENT LISTENERS - NAVIGASI
        // ==========================================
        playBtn.addEventListener('click', () => {
            menuScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
            openFullscreen();
        });

        settingsBtn.addEventListener('click', () => {
            settingsOverlay.classList.remove('hidden');
            settingsOverlay.classList.add('show');
        });

        levelmenuClose.addEventListener('click', () => {
            levelScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
        });

        effectSound.addEventListener('click', () => {
            if (!effectOn) {
                effectOn = true;
                effectSound.src = "{{ url_for('static', filename='gelembung_img/sound-active-button.png') }}";
                effectMute.src = "{{ url_for('static', filename='gelembung_img/mute-nonactive-button.png') }}";
            }
        });

        effectMute.addEventListener('click', () => {
            if (effectOn) {
                effectOn = false;
                effectSound.src = "{{ url_for('static', filename='gelembung_img/sound-nonactive-button.png') }}";
                effectMute.src = "{{ url_for('static', filename='gelembung_img/mute-active-button.png') }}";
            }
        });

        // === TOGGLE MUSIC ===
        musicSound.addEventListener('click', () => {
            if (!musicOn) {
                musicOn = true;
                musicSound.src = "{{ url_for('static', filename='gelembung_img/sound-active-button.png') }}";
                musicMute.src = "{{ url_for('static', filename='gelembung_img/mute-nonactive-button.png') }}";
                bgm.play();
            }
        });

        musicMute.addEventListener('click', () => {
            if (musicOn) {
                musicOn = false;
                musicSound.src = "{{ url_for('static', filename='gelembung_img/sound-nonactive-button.png') }}";
                musicMute.src = "{{ url_for('static', filename='gelembung_img/mute-active-button.png') }}";
                bgm.pause();
            }
        });

        // === CLOSE BUTTON ===
        closeSettings.addEventListener('click', () => {
            settingsOverlay.classList.add('hidden');
        });

        window.addEventListener('DOMContentLoaded', () => {
            bgm.volume = 0.7;
            bgm.play().catch(() => {
            });
            });

        quitBtn.addEventListener('click', () => { 
            window.location.href = '/';
        });

        understandBtn.addEventListener('click', () => {
            tutorialScreen.classList.add('hidden');
            isTutorialActive = false;
            countdownActive = true;
            countdownStartTime = Date.now();
        });
        
        homeBtn.addEventListener('click', () => {
            stopGame();
            resetGameState();
            resultScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
        });

        retryBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            startLevel(currentLevel);
        });
        
        nextLevelBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            if (currentLevel < 3 && playerProgress[currentLevel + 1].unlocked) {
                startLevel(currentLevel + 1);
            }
        });

        pauseBtn.addEventListener('click', () => {
            if (gameOver || gameWon || gamePaused) return;
            gamePaused = true;
            pauseStartTime = Date.now();
            pauseOverlay.classList.remove('hidden');
            bgm.pause();
        });
        
        pauseContinue.addEventListener('click', () => {
            if (!gamePaused) return;
            gamePaused = false;
            totalPausedDuration += Date.now() - pauseStartTime;
            pauseOverlay.classList.add('hidden');
            bgm.play();
        });

        pauseHome.addEventListener('click', () => {
            gamePaused = false;
            pauseOverlay.classList.add('hidden');
            stopGame();
            resetGameState();
            gameScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
        });

        pauseRetry.addEventListener('click', () => {
            gamePaused = false;
            pauseOverlay.classList.add('hidden');
            resetGameState();
            startLevel(currentLevel);
        });

        // Level button click handlers
        level1Btn.addEventListener('click', () => {
            if (playerProgress[1].unlocked) startLevel(1);
        });

        level2Btn.addEventListener('click', () => {
            if (playerProgress[2].unlocked) startLevel(2);
        });

        level3Btn.addEventListener('click', () => {
            if (playerProgress[3].unlocked) startLevel(3);
        });

        // ==========================================
        // FUNGSI GAME - INITIALIZATION
        // ==========================================
        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        }

        function startLevel(level) {
            currentLevel = level;
            levelScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            tutorialScreen.classList.remove('hidden');
            
            resetGameState();
            startGame();
        }

        function resetGameState() {
            score = 0;
            lives = 3;
            gameOver = false;
            gameWon = false;
            gameStarted = false;
            isTutorialActive = true;
            countdownActive = false;
            countdownStartTime = 0;
            countdownNumber = 3;
            gameStartTime = 0;
            elapsedSeconds = 0;
            bubbles = [];
        }

        function startGame() {
            loadingContainer.classList.remove('hidden');
            gameWrapper.classList.add('hidden');

            if (!hands) {
                hands = new window.Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                hands.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                hands.onResults(onResults);
            }
            if (!camera) {
                camera = new window.Camera(videoElement, {
                    onFrame: async () => await hands.send({ image: videoElement }),
                    width: 640, height: 480,
                });
            }
            camera.start().catch(err => {
                loadingText.innerText = 'Gagal mengakses kamera. Pastikan diizinkan.';
            });
        }

        function stopGame() {
            if (camera) {
                camera.stop();
            }
        }

        // ==========================================
        // GAME LOOP UTAMA
        // ==========================================
        function onResults(results) {
            if (gamePaused) {
                // Simpan frame terakhir biar tampil statis
                if (results) lastResults = results;

                // Gambar frame terakhir aja (freeze tampilan)
                if (lastResults) {
                    const w = canvasElement.width;
                    const h = canvasElement.height;
                    canvasCtx.save();
                    canvasCtx.clearRect(0, 0, w, h);
                    canvasCtx.scale(-1, 1);
                    canvasCtx.translate(-w, 0);
                    canvasCtx.drawImage(lastResults.image, 0, 0, w, h);
                    canvasCtx.restore();

                    drawGameElements(lastResults, w, h);
                    drawUI(w, h);
                }
                return; // Hentikan logika lain
            }

            // Jalankan logika normal
            if (!gameStarted && videoElement.videoWidth > 0) {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
                gameStarted = true;
                loadingContainer.classList.add('hidden');
                gameWrapper.classList.remove('hidden');
            }
            if (!gameStarted) return;

            const w = canvasElement.width;
            const h = canvasElement.height;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, w, h);
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-w, 0);
            canvasCtx.drawImage(results.image, 0, 0, w, h);
            canvasCtx.restore();

            if (isTutorialActive) return;

            // Hanya update jika tidak pause dan tidak game over
            if (!gameOver && !gameWon && !gamePaused) {
                updateCountdown();
                if (!countdownActive) {
                    updateGameLogic(results, w, h);
                    checkWinCondition();
                }
            }

            drawGameElements(results, w, h);
            drawUI(w, h);

            if ((gameOver || gameWon) && !resultScreen.classList.contains('hidden') === false) {
                showResultScreen();
            }
        }

        function updateCountdown() {
            if (!countdownActive || gamePaused) return; // jangan lanjut kalau pause

            const elapsed = Date.now() - countdownStartTime;
            const count = 3 - Math.floor(elapsed / 1000);
            countdownNumber = Math.max(0, count);

            if (elapsed >= 3000 && countdownActive) {
                pauseBtn.classList.remove('hidden');
            }

            if (elapsed >= 3500) {
                countdownActive = false;
                gameStartTime = Date.now();
                totalPausedDuration = 0;
                
            }
        }

        function updateGameLogic(results, w, h) {
            const config = levelConfig[currentLevel];

            // Spawn bubbles sesuai maxBubbles level
            while (bubbles.length < config.maxBubbles) {
                let startX, startY, speedX, speedY;
                const side = Math.floor(Math.random() * 4);
                const baseSpeed = (Math.random() * 3 + 3) * config.speedMultiplier;
                switch (side) {
                    case 0: startX = Math.random() * w; startY = h + 50; speedX = 0; speedY = -baseSpeed; break;
                    case 1: startX = Math.random() * w; startY = -50; speedX = 0; speedY = baseSpeed; break;
                    case 2: startX = -50; startY = Math.random() * h; speedX = baseSpeed; speedY = 0; break;
                    case 3: startX = w + 50; startY = Math.random() * h; speedX = -baseSpeed; speedY = 0; break;
                }

                const typeList = config.allowedTypes;
                const type = typeList[Math.floor(Math.random() * typeList.length)];

                bubbles.push({
                    x: startX,
                    y: startY,
                    speedX,
                    speedY,
                    type,
                    popping: false,
                    popStartTime: 0,
                    frameIndex: 0,
                });
            }

            const bubblesToKeep = [];

            for (const bubble of bubbles) {
                bubble.x += bubble.speedX;
                bubble.y += bubble.speedY;

                let isPopped = false
                const bubbleRadius = 50;
                const handRadius = 60;

                // Deteksi tangan
                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        const palmCenter = landmarks[9];
                        const handX = (1 - palmCenter.x) * w;
                        const handY = palmCenter.y * h;
                        const dist = Math.hypot(handX - bubble.x, handY - bubble.y);
                        if (dist < bubbleRadius + handRadius) {
                            isPopped = true;
                            break;
                        }
                    }
                }

                // Proses bubble jika kena tangan
                if (isPopped && !bubble.popping) {
                    bubble.popping = true;
                    bubble.popStartTime = Date.now();

                    if (bubble.type === "bomb") {
                        lives -= 1;
                        if (lives <= 0) gameOver = true;
                    } else {
                        score += 10;
                    }

                } else if (
                    !bubble.popping &&
                    bubble.type !== "bomb" && // ← tambahkan ini!
                    (
                        bubble.y < -100 || bubble.y > h + 100 ||
                        bubble.x < -100 || bubble.x > w + 100
                    )
                ) {
                    lives -= 1;
                    if (lives <= 0) gameOver = true;
                }

                const POP_DURATION = bubbleAnim.frameCount * bubbleAnim.frameSpeed;

                if (
                    (!bubble.popping && 
                    bubble.y >= -100 && bubble.y <= h + 100 &&
                    bubble.x >= -100 && bubble.x <= w + 100) ||
                    (bubble.popping && Date.now() - bubble.popStartTime < POP_DURATION)
                ) {
                    bubblesToKeep.push(bubble);
                }
            }

            bubbles = bubblesToKeep;
        }

        function checkWinCondition() {
            const config = levelConfig[currentLevel];
            if (score >= config.targetScore && !gameWon) {
                gameWon = true;
            }
        }

        function showResultScreen() {

            // Jangan langsung sembunyikan gameScreen, biar kelihatan di belakang popup
            resultScreen.classList.remove('hidden');
            
            const popup = document.getElementById('result-popup');
            const resultImg = document.getElementById('result-image');
            const resultStatus = document.getElementById('result-status');
            const resultScore = document.getElementById('result-score');

            // Reset animasi popup
            popup.classList.remove('active'); 
            void popup.offsetWidth; // force reflow biar animasi bisa diulang
            popup.classList.add('active');

            // Tentukan jumlah bintang
            const stars = gameWon ? calculateStars(score, elapsedSeconds) : 0;

            if (score >= 100){
                resultImg.src = images.resultStar3.src
            }
            else if (score >= 80) {
                resultImg.src = images.resultStar2.src
            }
            else if (score >= 60) {
                resultImg.src = images.resultStar1.src
            }
            else {
                resultImg.src = images.resultStar0.src
            }

            // Teks status
            if (stars >= 1) {
                resultStatus.textContent = "KERJA BAGUS!";
                resultStatus.style.color = "#045170";
            } else {
                resultStatus.textContent = "COBA LAGI";
                resultStatus.style.color = "#00446b";
            }

            // Skor
            resultScore.textContent = score;

            if (score >= 60) {
                nextLevelBtn.classList.remove("hidden");
            } else {
                nextLevelBtn.classList.add("hidden");
            }

            if (playerProgress[3].unlocked){
                nextLevelBtn.classList.add("hidden");
            }

            // Simpan progress
            if (score >= 60) {
                unlockNextLevel(currentLevel);
            }
        }

        // ==========================================
        // RENDERING - GAME ELEMENTS
        // ==========================================
        function drawGameElements(results, w, h) {
            if (gameOver || countdownActive || isTutorialActive) return;

            const bubbleSize = 100;
            for (const bubble of bubbles) {
                let img;
                if (bubble.type === "blue") img = images.blueBubbleAnimation;
                else if (bubble.type === "purple") img = images.purpleBubbleAnimation;
                else img = images.bomBubbleAnimation;

                if (bubble.popping) {
                    const elapsed = Date.now() - bubble.popStartTime;
                    const frame = Math.floor(elapsed / bubbleAnim.frameSpeed);
                    if (frame < bubbleAnim.frameCount) {
                        const sx = frame * bubbleAnim.frameWidth;
                        canvasCtx.drawImage(
                            img,
                            sx, 0, bubbleAnim.frameWidth, bubbleAnim.frameHeight,
                            bubble.x - bubbleSize / 2,
                            bubble.y - bubbleSize / 2,
                            bubbleSize, bubbleSize
                        );
                    }
                } else {
                    canvasCtx.drawImage(
                        img,
                        0, 0, bubbleAnim.frameWidth, bubbleAnim.frameHeight,
                        bubble.x - bubbleSize / 2,
                        bubble.y - bubbleSize / 2,
                        bubbleSize, bubbleSize
                    );
                }
            }

            // Draw hand water effect
            if (results.multiHandLandmarks) {
                const waterEffectSize = 120;
                
                for (const landmarks of results.multiHandLandmarks) {
                    const palmCenter = landmarks[9];
                    const handX = (1 - palmCenter.x) * w;
                    const handY = palmCenter.y * h;
                    
                    const now = Date.now();
                    if (now - waterAnim.lastFrameTime > waterAnim.frameSpeed) {
                        waterAnim.frameIndex = (waterAnim.frameIndex + 1) % waterAnim.frameCount;
                        waterAnim.lastFrameTime = now;
                    }
                    
                    const sx = waterAnim.frameIndex * waterAnim.frameWidth;
                    const sy = 0;

                    canvasCtx.drawImage(
                        images.waterEffectAnimation,
                        sx, sy, waterAnim.frameWidth, waterAnim.frameHeight, 
                        handX - waterEffectSize / 2,
                        handY - waterEffectSize / 2,
                        waterEffectSize, waterEffectSize 
                    );
                }
            }
        }

        // ==========================================
        // RENDERING - UI
        // ==========================================
        function drawUI(w, h) {
            // Water bottom decoration
            const waterBottomHeight = 150;
            canvasCtx.drawImage(images.waterBottom, 0, h - waterBottomHeight, w, waterBottomHeight);

            // Score panel dengan fill
            const panelWidth = 120, panelHeight = 420;
            const panelX = w - panelWidth - 140, panelY = h / 2 - panelHeight / 2;
            const scorePercentage = Math.min(score / levelConfig[currentLevel].targetScore, 1);
            
            if (scorePercentage > 0) {
                const fillHeight = panelHeight * 0.85 * scorePercentage;
                const fillWidth = panelWidth * 0.65;
                const fillOffsetX = ((panelWidth - fillWidth) / 2) + 10;
                const fillBottomOffset = -2;
                canvasCtx.drawImage(
                    images.scoreFill, 
                    0, images.scoreFill.height * (1 - scorePercentage), 
                    images.scoreFill.width, images.scoreFill.height * scorePercentage, 
                    panelX + fillOffsetX, 
                    panelY + (panelHeight - fillHeight - fillBottomOffset), 
                    fillWidth, 
                    fillHeight
                );
            }
            
            canvasCtx.drawImage(images.scorePanel, panelX, panelY, panelWidth, panelHeight);
            
            // Score text
            canvasCtx.fillStyle = '#045170';
            canvasCtx.font = '64px Lilita One';
            canvasCtx.textAlign = 'center';
            let displayScore = score < 10 ? score : String(score).padStart(2, '0');
            canvasCtx.fillText(displayScore, panelX + (panelWidth / 2) + 10, panelY - 20);

            // Life icons
            const lifeIconWidth = 100, lifeIconHeight = 90;
            for (let i = 0; i < lives; i++) {
                canvasCtx.drawImage(images.lifeCone, 60 + (i * (lifeIconWidth + 5)), 50, lifeIconWidth, lifeIconHeight);
            }

            // Timer
            if (!gameOver && !gameWon && gameStartTime > 0 && !countdownActive) {
                const now = gamePaused ? pauseStartTime : Date.now();
                elapsedSeconds = Math.floor(((now - totalPausedDuration) - gameStartTime) / 1000);
            }
            const timerWidth = 360, timerHeight = 180, timerX = w - timerWidth - 100, timerY = 20;
            canvasCtx.drawImage(images.timer, timerX, timerY, timerWidth, timerHeight);
            canvasCtx.fillStyle = '#20606D';
            canvasCtx.font = '40px Lilita One';
            canvasCtx.fillText(`Waktu : ${elapsedSeconds} detik`, timerX + timerWidth / 2, timerY + timerHeight / 2 + 50);

            // Countdown overlay
            if (countdownActive && countdownNumber > 0) {
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                canvasCtx.fillRect(0, 0, w, h);
                let img;
                if (countdownNumber === 3) img = images.countdownThree;
                if (countdownNumber === 2) img = images.countdownTwo;
                if (countdownNumber === 1) img = images.countdownOne;
                const imgWidth = 200, imgHeight = 240;
                if (img) canvasCtx.drawImage(img, (w - imgWidth) / 2, (h - imgHeight) / 2, imgWidth, imgHeight);
            }

            canvasCtx.textAlign = 'left';
        }

        // ==========================================
        // INITIALIZATION - Load progress saat start
        // ==========================================
        updateLevelButtons();

    </script>
</body>
</html>