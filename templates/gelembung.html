<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tangkap Rasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        /* Kontainer untuk setiap "layar" */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .hidden { display: none; }
        #gameCanvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
        }
        #webcam {
            transform: scaleX(-1);
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <!-- Import MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
    <audio id="bgm" src="{{ url_for('static', filename='audio/gelembung.m4a') }}" loop></audio>


    <!-- ======================== -->
    <!--     LAYAR 1: MENU UTAMA (Versi Multi-Layer) -->
    <!-- ======================== -->
    <div id="menu-screen" class="screen bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/bg.png') }}');">
        <div class="relative w-full h-full flex items-center justify-center">
            
            <!-- Panel Menu Utama -->
            <!-- TAMBAHKAN 'relative' DI SINI untuk menjadi acuan posisi tombol -->
            <div class="relative w-full max-w-8xl flex flex-col items-center">
                <img src="{{ url_for('static', filename='gelembung_img/titlebox.png') }}" alt="Menu Utama" class="w-10/12 z-10">

                <!-- Kontainer Tombol-Tombol -->
                <!-- GANTI class positioningnya dengan 'absolute' -->
                <div class="absolute bottom-12 md:bottom-16 left-0 right-0 flex justify-center gap-4 w-full z-20">
                    <button id="play-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonplay.png') }}" alt="Play" class="pointer-events-none">
                    </button>
                    <button id="settings-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonpengaturan.png') }}" alt="Pengaturan" class="pointer-events-none">
                    </button>
                    <button id="quit-btn" class="w-1/6 transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/buttonkeluar.png') }}" alt="Keluar" class="pointer-events-none">
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ======================== -->
    <!--   LAYAR 1.5: PILIH LEVEL  -->
    <!-- ======================== -->
    <div id="level-screen" class="fixed top-0 left-0 w-full h-full hidden bg-cover bg-center" style="background-image: url('{{ url_for('static', filename='gelembung_img/background.png') }}');">
        
        <!-- Wrapper 'relative' yang mengisi seluruh layar untuk menjadi acuan posisi absolut -->
        <div class="relative w-full h-full">
            
            <!-- Box Level, diposisikan absolut di atas-tengah. Jarak dari atas diubah jadi 15% -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 max-w-2xl">
                <img src="{{ url_for('static', filename='gelembung_img/levelbox.png') }}" alt="Pilih Level Box" class="w-full">
                
                <!-- Container Tombol Level, dibuat 'absolute' agar menimpa gambar box -->
                <div class="absolute inset-0 flex justify-center items-end gap-6 lg:pb-80">
                    <button id="level-1-btn" class="transform hover:scale-110 transition-transform duration-200">
                        <img src="{{ url_for('static', filename='gelembung_img/level1btn.png') }}" alt="Level 1" class="w-24 md:w-32">
                    </button>
                    <button id="level-2-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 2 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                    <button id="level-3-btn" class="cursor-not-allowed" disabled>
                        <img src="{{ url_for('static', filename='gelembung_img/levellock.png') }}" alt="Level 3 Locked" class="w-24 md:w-32 opacity-50">
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="tutorial-screen" class="screen hidden" style="background-color: rgba(0, 0, 0, 0.7);  z-index: 20;">
        <div class="flex flex-col items-center gap-8 ">
            <img src="{{ url_for('static', filename='gelembung_img/tutorial.png') }}" alt="Tutorial Cara Bermain" class="w-full">
            
            <button id="understand-btn" class="w-1/4 max-w-xs transform hover:scale-110 transition-transform duration-200">
                <img src="{{ url_for('static', filename='gelembung_img/mulaiButton.png') }}" alt="Lanjutkan">
            </button>
        </div>
    </div>
    

    <!-- ======================== -->
    <!--     LAYAR 2: GAMEPLAY      -->
    <!-- ======================== -->
    <div id="game-screen" class="screen hidden bg-black" style="z-index: 10;">
        <div id="loading-container" class="flex flex-col items-center justify-center bg-white p-8 rounded-lg shadow-lg">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-gray-700 font-semibold">Menunggu akses kamera...</p>
        </div>
        <div id="game-wrapper" class="w-full h-full hidden">
            <button id="exit-game-btn" class="absolute top-4 left-4 z-10 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">
                &larr; Keluar
            </button>
            <video id="webcam" style="position: absolute; visibility: hidden;" autoplay playsinline></video>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>


    <!-- ======================== -->
    <!--      LOGIKA JAVASCRIPT     -->
    <!-- ======================== -->
    <script>
        // --- MANAJEMEN LAYAR & NAVIGASI ---
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const levelScreen = document.getElementById('level-screen');
        const tutorialScreen = document.getElementById('tutorial-screen');

        const playBtn = document.getElementById('play-btn');
        const level1Btn = document.getElementById('level-1-btn');
        const understandBtn = document.getElementById('understand-btn'); // Variabel yang hilang ditambahkan
        const settingsBtn = document.getElementById('settings-btn');
        const quitBtn = document.getElementById('quit-btn');
        const exitGameBtn = document.getElementById('exit-game-btn');
        const bgm = document.getElementById('bgm');

        playBtn.addEventListener('click', () => {
            menuScreen.classList.add('hidden');
            levelScreen.classList.remove('hidden');
            openFullscreen();
        });
        settingsBtn.addEventListener('click', () => { alert('Halaman Pengaturan belum dibuat!'); });
        quitBtn.addEventListener('click', () => { alert('Tombol Keluar ditekan!'); });
        exitGameBtn.addEventListener('click', () => {
            stopGame();
            gameScreen.classList.add('hidden');
            menuScreen.classList.remove('hidden');
        });
        level1Btn.addEventListener('click', () => {
            levelScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            tutorialScreen.classList.remove('hidden');
            startGame();
            bgm.play();
        });
        understandBtn.addEventListener('click', () => {
            tutorialScreen.classList.add('hidden');
            isTutorialActive = false; // Nonaktifkan tutorial
            countdownActive = true;   // Mulai countdown
            countdownStartTime = Date.now();
        });

        // --- Variabel & Referensi Game ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('gameCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingContainer = document.getElementById('loading-container');
        const loadingText = document.getElementById('loading-text');
        const gameWrapper = document.getElementById('game-wrapper');

        let score, lives, gameOver, gameStarted, bubbles, hands, camera;
        let isTutorialActive = true;
        let gameWon = false;
        let gameWonAnimationY = -500;
        let gameWonAnimationStartTime = 0;
        let gameStartTime = 0;
        let elapsedSeconds = 0;
        let countdownActive = false;
        let countdownStartTime = 0;
        let countdownNumber = 3;

        // --- ASET GAMBAR ---
        // Objek untuk menyimpan semua gambar yang sudah dimuat
        const images = {};
        const imageUrls = {
            bubble: "{{ url_for('static', filename='gelembung_img/gelembung.png') }}",
            scorePanel: "{{ url_for('static', filename='gelembung_img/scorepanel.png') }}",
            lifeCone: "{{ url_for('static', filename='gelembung_img/life.png') }}",
            waterEffect: "{{ url_for('static', filename='gelembung_img/efek-air.png') }}",
            waterBottom: "{{ url_for('static', filename='gelembung_img/air.png') }}",
            scoreFill: "{{ url_for('static', filename='gelembung_img/scorefill.png') }}",
            gameOver: "{{ url_for('static', filename='gelembung_img/gameover.png') }}",
            timer: "{{ url_for('static', filename='gelembung_img/timer.png') }}",
            countdownThree: "{{ url_for('static', filename='gelembung_img/Three.png') }}",
            countdownTwo: "{{ url_for('static', filename='gelembung_img/Two.png') }}",
            countdownOne: "{{ url_for('static', filename='gelembung_img/One.png') }}"
        };
        // Memuat semua gambar
        Object.keys(imageUrls).forEach(key => {
            images[key] = new Image();
            images[key].src = imageUrls[key];
        });

        function openFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
            else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        }

        // --- FUNGSI UTAMA GAME LOOP ---
        function onResults(results) {
            if (!gameStarted && videoElement.videoWidth > 0) {
                canvasElement.width = window.innerWidth;
                canvasElement.height = window.innerHeight;
                gameStarted = true;
                loadingContainer.classList.add('hidden');
                gameWrapper.classList.remove('hidden');
            }
            if (!gameStarted) return;

            const w = canvasElement.width;
            const h = canvasElement.height;

            // LANGKAH 1: GAMBAR LATAR BELAKANG (KAMERA MIRROR)
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, w, h);
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-w, 0);
            canvasCtx.drawImage(results.image, 0, 0, w, h);
            canvasCtx.restore();

            if (isTutorialActive) return;

            // LANGKAH 2: UPDATE LOGIKA GAME (JIKA TIDAK GAME OVER/WON)
            if (!gameOver && !gameWon) {
                updateCountdown();
                if (!countdownActive) {
                    updateGameLogic(results, w, h);
                }
            }

            // LANGKAH 3: GAMBAR SEMUA ELEMEN DI ATAS KAMERA
            drawGameElements(results, w, h);

            // LANGKAH 4: GAMBAR UI & OVERLAY
            drawUI(w, h);
        }

        function updateCountdown() {
            if (!countdownActive) return;
            const elapsed = Date.now() - countdownStartTime;
            const count = 3 - Math.floor(elapsed / 1000);
            countdownNumber = Math.max(0, count);
            if (elapsed >= 3500) {
                countdownActive = false;
                gameStartTime = Date.now();
            }
        }

        function updateGameLogic(results, w, h) {
            if (bubbles.length === 0) {
                let startX, startY, speedX, speedY;
                const side = Math.floor(Math.random() * 4);
                const speed = Math.random() * 3 + 3;
                switch (side) {
                    case 0: startX = Math.random() * w; startY = h + 50; speedX = 0; speedY = -speed; break;
                    case 1: startX = Math.random() * w; startY = -50; speedX = 0; speedY = speed; break;
                    case 2: startX = -50; startY = Math.random() * h; speedX = speed; speedY = 0; break;
                    case 3: startX = w + 50; startY = Math.random() * h; speedX = -speed; speedY = 0; break;
                }
                bubbles.push({ x: startX, y: startY, speedX, speedY });
            }

            const bubblesToKeep = [];
            for (const bubble of bubbles) {
                bubble.x += bubble.speedX;
                bubble.y += bubble.speedY;
                let isPopped = false;
                const bubbleRadius = 50;
                const handRadius = 60;

                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        const palmCenter = landmarks[9];
                        const handX = (1 - palmCenter.x) * w;
                        const handY = palmCenter.y * h;
                        const dist = Math.hypot(handX - bubble.x, handY - bubble.y);
                        if (dist < bubbleRadius + handRadius) {
                            isPopped = true;
                            break;
                        }
                    }
                }

                if (isPopped) {
                    score += 10;
                    if (score >= 100) {
                        gameWon = true;
                        gameWonAnimationStartTime = Date.now();
                    }
                } else if (bubble.y < -100 || bubble.y > h + 100 || bubble.x < -100 || bubble.x > w + 100) {
                    lives -= 1;
                } else {
                    bubblesToKeep.push(bubble);
                }
            }
            bubbles = bubblesToKeep;

            if (lives <= 0) gameOver = true;
        }

        function drawGameElements(results, w, h) {
            if (gameOver || countdownActive || isTutorialActive) return;

            const bubbleSize = 100;
            for (const bubble of bubbles) {
                canvasCtx.drawImage(images.bubble, bubble.x - bubbleSize / 2, bubble.y - bubbleSize / 2, bubbleSize, bubbleSize);
            }

            if (results.multiHandLandmarks) {
                const waterEffectSize = 120;
                for (const landmarks of results.multiHandLandmarks) {
                    const palmCenter = landmarks[9];
                    const handX = (1 - palmCenter.x) * w;
                    const handY = palmCenter.y * h;
                    canvasCtx.drawImage(images.waterEffect, handX - waterEffectSize / 2, handY - waterEffectSize / 2, waterEffectSize, waterEffectSize);
                }
            }
        }

        // Fungsi drawUI yang hilang kini sudah dibuat dan diisi
        function drawUI(w, h) {
            const waterBottomHeight = 150;
            canvasCtx.drawImage(images.waterBottom, 0, h - waterBottomHeight, w, waterBottomHeight);

            const panelWidth = 120, panelHeight = 420;
            const panelX = w - panelWidth - 140, panelY = h / 2 - panelHeight / 2;
            const scorePercentage = Math.min(score / 100, 1);
            if (scorePercentage > 0) {
                const fillHeight = panelHeight * 0.85 * scorePercentage;
                const fillWidth = panelWidth * 0.65;
                const fillOffsetX = ((panelWidth - fillWidth) / 2) + 10;
                const fillBottomOffset = -2;
                canvasCtx.drawImage(images.scoreFill, 0, images.scoreFill.height * (1-scorePercentage), images.scoreFill.width, images.scoreFill.height * scorePercentage, panelX + fillOffsetX, panelY + (panelHeight - fillHeight - fillBottomOffset), fillWidth, fillHeight);
            }
            canvasCtx.drawImage(images.scorePanel, panelX, panelY, panelWidth, panelHeight);
            canvasCtx.fillStyle = '#FFFFFF'; canvasCtx.font = 'bold 48px sans-serif'; canvasCtx.textAlign = 'center';
            canvasCtx.fillText(String(score).padStart(2, '0'), panelX + (panelWidth / 2) + 30, panelY - 20);

            const lifeIconWidth = 100, lifeIconHeight = 90;
            for (let i = 0; i < lives; i++) {
                canvasCtx.drawImage(images.lifeCone, 60 + (i * (lifeIconWidth + 5)), 50, lifeIconWidth, lifeIconHeight);
            }

            if (!gameOver && !gameWon && gameStartTime > 0) elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
            const timerWidth = 360, timerHeight = 180, timerX = w - timerWidth - 100, timerY = 20;
            canvasCtx.drawImage(images.timer, timerX, timerY, timerWidth, timerHeight);
            canvasCtx.fillStyle = '#2C5F6F'; canvasCtx.font = 'bold 36px sans-serif';
            canvasCtx.fillText(`Waktu : ${elapsedSeconds} detik`, timerX + timerWidth / 2, timerY + timerHeight / 2 + 50);

            if (countdownActive && countdownNumber > 0) {
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                canvasCtx.fillRect(0, 0, w, h);
                let img;
                if (countdownNumber === 3) img = images.countdownThree;
                if (countdownNumber === 2) img = images.countdownTwo;
                if (countdownNumber === 1) img = images.countdownOne;
                const imgWidth = 200, imgHeight = 240;
                if(img) canvasCtx.drawImage(img, (w - imgWidth) / 2, (h - imgHeight) / 2, imgWidth, imgHeight);
            } else if (gameWon) {
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                canvasCtx.fillRect(0, 0, w, h);
                const elapsed = Date.now() - gameWonAnimationStartTime;
                const progress = Math.min(elapsed / 1000, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const imgWidth = w * 0.3, imgHeight = imgWidth * (images.gameOver.height / images.gameOver.width);
                const targetY = (h - imgHeight) / 2;
                gameWonAnimationY = -imgHeight + (targetY + imgHeight) * easeOut;
                canvasCtx.drawImage(images.gameOver, (w - imgWidth) / 2, gameWonAnimationY, imgWidth, imgHeight);
            } else if (gameOver) {
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                canvasCtx.fillRect(0, h / 2 - 60, w, 120);
                canvasCtx.fillStyle = 'white'; canvasCtx.font = 'bold 50px sans-serif';
                canvasCtx.fillText('GAME OVER', w / 2, h / 2);
                canvasCtx.font = '30px sans-serif';
                canvasCtx.fillText(`Skor Akhir: ${score}`, w / 2, h / 2 + 40);
            }
            canvasCtx.textAlign = 'left';
        }

        function startGame() {
            score = 0; lives = 3; gameOver = false; gameStarted = false;
            gameWon = false; isTutorialActive = true;
            gameWonAnimationY = -500; gameWonAnimationStartTime = 0;
            gameStartTime = 0; elapsedSeconds = 0;
            countdownActive = false; countdownStartTime = 0; countdownNumber = 3;
            bubbles = [];

            loadingContainer.classList.remove('hidden');
            gameWrapper.classList.add('hidden');

            if (!hands) {
                hands = new window.Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                hands.setOptions({ maxNumHands: 2, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                hands.onResults(onResults);
            }
            if (!camera) {
                camera = new window.Camera(videoElement, {
                    onFrame: async () => await hands.send({ image: videoElement }),
                    width: 640, height: 480,
                });
            }
            camera.start().catch(err => {
                loadingText.innerText = 'Gagal mengakses kamera. Pastikan diizinkan.';
            });
        }

        function stopGame() {
            if (camera) {
                camera.stop();
                bgm.pause();
                bgm.currentTime = 0;
            }
        }

    </script>
</body>
</html>
